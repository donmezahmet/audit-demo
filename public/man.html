<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audit Actions Overview</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <!-- Choices.js CSS - Removed to fix CORB error -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/choices.js/public/assets/styles/choices.min.css" /> -->
  <!-- Choices.js JS - Removed to fix CORB error -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script> -->
  <style>

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f7fa;
      padding-top: 60px; /* Header height kadar padding ekle */
    }

    /* Login ekranƒ±nda body padding'ini kaldƒ±r */
    body.login-screen {
      padding-top: 0;
    }

    /* Loading Spinner Styles */
    .vp-loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: vp-spin 1s linear infinite;
      margin-right: 8px;
    }

    .vp-loading-spinner-large {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: vp-spin 1s linear infinite;
    }

    @keyframes vp-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .vp-header {
      background: linear-gradient(135deg, #5D3EBC 0%, #6B46C1 100%) !important;
      color: #ffffff !important;
      font-size: 20px !important;
      font-weight: 600 !important;
      box-shadow: 
        0 4px 20px rgba(93, 62, 188, 0.3),
        0 2px 10px rgba(0, 0, 0, 0.1) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: space-between !important;
      letter-spacing: -0.01em !important;
      height: 60px !important;
      line-height: 60px !important;
      padding: 0 32px !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      z-index: 1000 !important;
      backdrop-filter: blur(10px) !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
      border-radius: 0 0 20px 20px !important;
    }

    .vp-header-left, .vp-header-center, .vp-header-right {
      display: flex;
      align-items: center;
    }

    .vp-header-left {
      gap: 16px;
    }

    .vp-header-center {
      flex: 1;
      justify-content: center;
    }

    .vp-dashboard-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }

    .vp-header-right {
      gap: 16px;
    }

    /* VP View As Dropdown */
    .vp-view-as-dropdown {
      position: relative;
    }

    .vp-view-as-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .vp-view-as-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.3);
    }

    .vp-view-as-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      min-width: 300px;
      z-index: 1000;
      display: none;
    }

    .vp-view-as-menu.show {
      display: block;
    }

    .vp-view-as-menu input {
      width: 100%;
      padding: 12px;
      border: none;
      border-bottom: 1px solid #e5e7eb;
      border-radius: 8px 8px 0 0;
      font-size: 14px;
    }

    .vp-user-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .vp-user-item {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .vp-user-item:hover {
      background-color: #f9fafb;
    }

    .vp-user-item:last-child {
      border-bottom: none;
    }

    .vp-user-name {
      font-weight: 500;
      color: #111827;
    }

    .vp-user-email {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }

    /* VP User Avatar */
    .vp-user-avatar-dropdown {
      position: relative;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10000;
    }

    .vp-user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .vp-user-avatar:hover {
      border-color: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }

    /* VP Header Button */
    .vp-header-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .vp-header-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.3);
    }

    .vp-header-btn.vp-stop-impersonation {
      background: linear-gradient(135deg, #fdcb6e, #e17055);
      border: 1px solid rgba(255, 255, 255, 0.4);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .vp-header-btn.vp-stop-impersonation:hover {
      background: linear-gradient(135deg, #fcc35e, #d65a45);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(253, 203, 110, 0.4);
    }

    .vp-stop-impersonation {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.3);
    }

    .vp-stop-impersonation:hover {
      background: rgba(239, 68, 68, 0.3);
      border-color: rgba(239, 68, 68, 0.4);
    }

    .vp-logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }


    .vp-user-info {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
      color: #ffffff;
      margin-left: auto;
      margin-top: -10px;
    }

    .vp-user-email {
      font-weight: 500;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      font-size: 13px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* VP Panel Styles */
    .vp-panel {
      display: none;
      position: relative;
      margin-left: 10px;
    }

    .vp-panel.show {
      display: block;
    }

    .vp-toggle {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .vp-toggle::before {
      content: '';
      font-size: 14px;
    }

    .vp-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    .vp-dropdown {
      position: fixed;
      top: 80px;
      right: 150px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9));
      backdrop-filter: blur(20px);
      border: none;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
      min-width: 320px;
      z-index: 10000;
      display: none;
      overflow: hidden;
    }

    .vp-dropdown::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
      background-size: 300% 100%;
      animation: vp-gradientShift 3s ease infinite;
    }

    @keyframes vp-gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .vp-dropdown.show {
      display: block;
    }

    .vp-dropdown-header {
      padding: 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .vp-dropdown-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .vp-dropdown-content {
      padding: 0;
      max-height: 400px;
      overflow-y: auto;
    }

    .vp-dropdown-item {
      padding: 12px 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .vp-dropdown-item:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    }

    .vp-dropdown-item:last-child {
      border-bottom: none;
    }

    .vp-dropdown-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #667eea;
    }

    .vp-dropdown-text {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    .vp-dropdown-subtitle {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    /* Main Content */
    .vp-main-content {
      padding: 20px;
      margin-top: 20px;
    }

    /* VP Actions Container */
    .vp-actions-container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    /* VP Director Dashboard (Left Section) */
    .vp-director-dashboard {
      flex: 1;
      margin: 0;
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      text-align: left;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #e8ecf0;
      display: flex;
      flex-direction: column;
      height: 380px;
    }

    /* VP Dashboard Content (Right Section - Chart) */
    .vp-dashboard-content {
      flex: 1;
      width: auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #e8ecf0;
      display: flex;
      flex-direction: column;
      height: 380px;
    }

    /* VP Header Section */
    .vp-header-section {
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
      margin: 0 0 8px 0;
      color: #2c3e50;
      text-align: left !important;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .vp-welcome {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }

    .vp-badge {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #f8f9fa;
      padding: 12px 20px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .vp-icon {
      font-size: 20px;
      color: #667eea;
    }

    .vp-title {
      font-size: 24px;
      font-weight: 700;
      color: #2c3e50;
      white-space: nowrap;
    }

    .vp-subtitle {
      font-size: 14px;
      color: #6c757d;
      font-weight: 400;
      margin-left: 8px;
    }

    /* VP Loading Container */
    .vp-loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
    }

    .vp-spinner {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
    }

    .vp-loading-text {
      color: #7f8c8d;
      font-size: 14px;
      margin: 0;
    }

    /* VP Chart Header */
    .vp-chart-header {
      margin-bottom: 20px;
    }

    .vp-chart-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
      margin: 0;
    }

    /* VP Modern Chart Container */
    .vp-modern-chart-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .vp-modern-loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      text-align: center;
    }

    .vp-modern-spinner {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
    }

    /* VP Modern Filter Bar */
    .vp-modern-filter-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .vp-toggle-option-modern {
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: transparent;
      border: 1px solid transparent;
    }

    .vp-toggle-option-modern.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .vp-toggle-text-modern {
      font-size: 12px;
      font-weight: 500;
    }

    /* VP Pie Chart Container */
    .vp-pie-chart-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .vp-pie-chart-container canvas {
      max-width: 100%;
      max-height: 100%;
    }

    /* VP Department Stats */
    .vp-department-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 15px;
      justify-content: space-between;
      align-items: center;
    }
    
    /* VP Overdue kartlarƒ± alt satƒ±rda ortalanmƒ±≈ü */
    .vp-stat-item.vp-overdue-rate-card {
      grid-column: 2;
      grid-row: 2;
    }
    
    .vp-stat-item.vp-overdue-actions-card {
      grid-column: 3;
      grid-row: 2;
    }
    
    /* VP √úst satƒ±rdaki kartlar */
    .vp-stat-item.vp-total-actions-card {
      grid-column: 1;
      grid-row: 1 / span 2;
      height: 255px; /* 2 satƒ±r y√ºksekliƒüi (120px + 15px gap + 120px) */
    }
    
    .vp-stat-item.vp-completion-rate-card {
      grid-column: 2;
      grid-row: 1;
    }
    
    .vp-stat-item.vp-open-actions-card {
      grid-column: 3;
      grid-row: 1;
    }

    .vp-stat-item {
      text-align: center;
      flex: 1;
      min-width: 120px;
      height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 15px;
      box-sizing: border-box;
    }

    .vp-stat-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.15);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 10px 14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      height: 100%;
      width: 100%;
    }

    .vp-stat-icon {
      font-size: 16px;
      opacity: 0.9;
    }

    .vp-stat-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .vp-stat-number {
      display: block;
      font-size: 32px;
      font-weight: 800;
      color: #667eea;
      margin-bottom: 4px;
    }

    .vp-stat-label {
      font-size: 12px;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .vp-toggle-indicator {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 255, 255, 0.9);
      color: #666;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      z-index: 1;
    }

    .vp-fixed-as-of-2024 {
      background: rgba(52, 152, 219, 0.1);
      color: #3498db;
      border: 1px solid rgba(52, 152, 219, 0.3);
    }

    /* VP Total Actions Card */
    .vp-stat-item.vp-total-actions-card {
      background: linear-gradient(135deg, 
        rgba(99, 102, 241, 0.08) 0%, 
        rgba(255, 255, 255, 0.95) 20%,
        rgba(255, 255, 255, 0.98) 100%);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-left: 4px solid #6366f1;
      box-shadow: 
        0 4px 12px rgba(99, 102, 241, 0.1),
        0 2px 6px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }

    .vp-stat-item.vp-total-actions-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(20px, -20px);
    }

    .vp-stat-item.vp-total-actions-card .vp-stat-icon {
      color: #6366f1;
      filter: drop-shadow(0 2px 4px rgba(99, 102, 241, 0.3));
      font-size: 28px;
    }

    .vp-stat-item.vp-total-actions-card .vp-stat-number {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 1px 2px rgba(99, 102, 241, 0.2));
      font-weight: 700;
    }

    .vp-stat-item.vp-total-actions-card .vp-stat-label {
      color: #4338ca;
      font-weight: 600;
    }

    /* VP Completion Rate Card */
    .vp-stat-item.vp-completion-rate-card {
      background: linear-gradient(135deg, 
        rgba(34, 197, 94, 0.08) 0%, 
        rgba(255, 255, 255, 0.95) 20%,
        rgba(255, 255, 255, 0.98) 100%);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-left: 4px solid #22c55e;
      box-shadow: 
        0 4px 12px rgba(34, 197, 94, 0.1),
        0 2px 6px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }

    .vp-stat-item.vp-completion-rate-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, rgba(34, 197, 94, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(20px, -20px);
    }

    .vp-stat-item.vp-completion-rate-card .vp-stat-icon {
      color: #22c55e;
      filter: drop-shadow(0 2px 4px rgba(34, 197, 94, 0.3));
      font-size: 28px;
    }

    .vp-stat-item.vp-completion-rate-card .vp-stat-number {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 1px 2px rgba(34, 197, 94, 0.2));
      font-weight: 700;
    }

    .vp-stat-item.vp-completion-rate-card .vp-stat-label {
      color: #15803d;
      font-weight: 600;
    }

    /* VP Overdue Rate Card */
    .vp-stat-item.vp-overdue-rate-card {
      background: linear-gradient(135deg, 
        rgba(245, 158, 11, 0.08) 0%, 
        rgba(255, 255, 255, 0.95) 20%,
        rgba(255, 255, 255, 0.98) 100%);
      border: 1px solid rgba(245, 158, 11, 0.2);
      border-left: 4px solid #f59e0b;
      box-shadow: 
        0 4px 12px rgba(245, 158, 11, 0.1),
        0 2px 6px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }

    .vp-stat-item.vp-overdue-rate-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, rgba(245, 158, 11, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(20px, -20px);
    }

    .vp-stat-item.vp-overdue-rate-card .vp-stat-icon {
      color: #f59e0b;
      filter: drop-shadow(0 2px 4px rgba(245, 158, 11, 0.3));
      font-size: 28px;
    }

    .vp-stat-item.vp-overdue-rate-card .vp-stat-number {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 1px 2px rgba(245, 158, 11, 0.2));
      font-weight: 700;
    }

    .vp-stat-item.vp-overdue-rate-card .vp-stat-label {
      color: #b45309;
      font-weight: 600;
    }

    /* VP Open Actions Card */
    .vp-stat-item.vp-open-actions-card {
      background: linear-gradient(135deg, 
        rgba(59, 130, 246, 0.08) 0%, 
        rgba(255, 255, 255, 0.95) 20%,
        rgba(255, 255, 255, 0.98) 100%);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-left: 4px solid #3b82f6;
      box-shadow: 
        0 4px 12px rgba(59, 130, 246, 0.1),
        0 2px 6px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }

    .vp-stat-item.vp-open-actions-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(20px, -20px);
    }

    .vp-stat-item.vp-open-actions-card .vp-stat-number {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 1px 2px rgba(59, 130, 246, 0.2));
      font-weight: 700;
    }

    .vp-stat-item.vp-open-actions-card .vp-stat-label {
      color: #1d4ed8;
      font-weight: 600;
    }

    /* VP Overdue Actions Card */
    .vp-stat-item.vp-overdue-actions-card {
      background: linear-gradient(135deg, 
        rgba(239, 68, 68, 0.08) 0%, 
        rgba(255, 255, 255, 0.95) 20%,
        rgba(255, 255, 255, 0.98) 100%);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-left: 4px solid #ef4444;
      box-shadow: 
        0 4px 12px rgba(239, 68, 68, 0.1),
        0 2px 6px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }

    .vp-stat-item.vp-overdue-actions-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, rgba(239, 68, 68, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(20px, -20px);
    }

    .vp-stat-item.vp-overdue-actions-card .vp-stat-number {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 1px 2px rgba(239, 68, 68, 0.2));
      font-weight: 700;
    }

    .vp-stat-item.vp-overdue-actions-card .vp-stat-label {
      color: #b91c1c;
      font-weight: 600;
    }

    /* VP Hover effects */
    .vp-stat-item.vp-total-actions-card:hover,
    .vp-stat-item.vp-completion-rate-card:hover,
    .vp-stat-item.vp-overdue-rate-card:hover,
    .vp-stat-item.vp-open-actions-card:hover,
    .vp-stat-item.vp-overdue-actions-card:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.1),
        0 4px 12px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    .vp-stat-item.vp-total-actions-card:hover::before,
    .vp-stat-item.vp-completion-rate-card:hover::before,
    .vp-stat-item.vp-overdue-rate-card:hover::before,
    .vp-stat-item.vp-open-actions-card:hover::before,
    .vp-stat-item.vp-overdue-actions-card:hover::before {
      transform: translate(15px, -15px) scale(1.1);
      transition: all 0.3s ease;
    }

    /* VP Charts */
    .vp-charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .vp-chart-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .vp-chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .vp-chart-title {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
    }

    .vp-chart-container {
      position: relative;
      height: 300px;
    }

    /* Modern Action Ownership Breakdown Styles */
    .vp-modern-ownership-container {
      display: flex;
      gap: 24px;
      padding: 18px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.8);
      min-height: 300px;
      max-height: 320px;
    }

    .vp-ownership-chart-section {
      position: relative;
      flex: 0 0 260px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .vp-donut-chart-container {
      position: relative;
      width: 250px;
      height: 250px;
    }

    .vp-ownership-center-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 10;
    }

    .vp-center-number {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
      line-height: 1;
      margin-bottom: 4px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .vp-center-label {
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .vp-ownership-breakdown-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding-top: 45px;
    }

    .vp-breakdown-cards {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .vp-breakdown-cards::-webkit-scrollbar {
      width: 4px;
    }

    .vp-breakdown-cards::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 2px;
    }

    .vp-breakdown-cards::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 2px;
    }

    .vp-breakdown-cards::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .vp-ownership-card {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.6);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .vp-ownership-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .vp-ownership-color-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .vp-ownership-info {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .vp-ownership-name {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .vp-ownership-email {
      font-size: 11px;
      color: #64748b;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    }

    .vp-ownership-stats {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      text-align: right;
    }

    .vp-ownership-count {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      line-height: 1;
    }

    .vp-ownership-percentage {
      font-size: 11px;
      color: #64748b;
      font-weight: 500;
    }

    .vp-ownership-status-badges {
      display: flex;
      gap: 4px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .vp-status-badge {
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .vp-status-badge.open {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    .vp-status-badge.completed {
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
    }

    .vp-status-badge.overdue {
      background: rgba(249, 115, 22, 0.1);
      color: #ea580c;
    }

    .vp-status-badge.risk-accepted {
      background: rgba(168, 85, 247, 0.1);
      color: #9333ea;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .vp-modern-ownership-container {
        flex-direction: column;
        gap: 16px;
      }

      .vp-ownership-chart-section {
        flex: none;
      }

      .vp-donut-chart-container {
        width: 240px;
        height: 240px;
      }

      .vp-center-number {
        font-size: 24px;
      }
    }

    /* VP Filter Bar */
    .vp-filter-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding: 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .vp-filter-label {
      font-size: 14px;
      font-weight: 600;
      color: #666;
    }

    .vp-filter-select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    /* VP Loading States */
    .vp-loading-container {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #666;
    }

    .vp-loading-text {
      margin-left: 12px;
      font-size: 14px;
    }

    /* VP Error States */
    .vp-error-container {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #e74c3c;
      background: #fdf2f2;
      border-radius: 12px;
      border: 1px solid #fecaca;
    }

    .vp-error-text {
      margin-left: 12px;
      font-size: 14px;
    }

    /* VP Responsive Design */
    @media (max-width: 768px) {
      .vp-actions-container {
        flex-direction: column;
        gap: 15px;
      }

      .vp-director-dashboard,
      .vp-dashboard-content {
        width: 100%;
        flex: none;
        padding: 15px;
      }

      .vp-department-stats {
        gap: 20px;
      }

      .vp-stat-number {
        font-size: 24px;
      }

      .vp-department-stats {
        flex-direction: column;
        gap: 12px;
      }
    }

    /* VP Login Screen */
    .vp-login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .vp-login-container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 400px;
      width: 100%;
    }

    .vp-login-title {
      font-size: 28px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 20px;
    }

    .vp-login-subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .vp-login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .vp-login-input {
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .vp-login-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .vp-login-button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .vp-login-button:hover {
      transform: translateY(-2px);
    }

    .vp-login-error {
      color: #e74c3c;
      font-size: 14px;
      margin-top: 10px;
    }

    /* VP Hidden Elements */
    .vp-hidden {
      display: none !important;
    }

  </style>
</head>
<body>
  <!-- VP Dashboard Section -->
  <div id="vpDashboardContainer">
    <!-- VP Header -->
    <header class="vp-header">
      <div class="vp-header-left">
        <img src="logo.png" alt="Logo" class="vp-logo">
        <span class="vp-dashboard-title">Audit Department Executive Dashboard</span>
      </div>
      <div class="vp-header-center">
      </div>
      <div class="vp-header-right">
        <!-- View As Dropdown (Admin only) -->
        <div id="vpViewAsDropdown" class="vp-view-as-dropdown" style="display: none;">
          <button class="vp-view-as-btn" onclick="vpToggleViewAsDropdown()">
            <i class="fas fa-user-secret"></i>
            View As
          </button>
          <div id="vpViewAsMenu" class="vp-view-as-menu">
            <input type="text" id="vpUserSearch" placeholder="Search user..." oninput="vpSearchUsers()">
            <div id="vpUserList" class="vp-user-list">
              <!-- Users will be loaded here -->
            </div>
          </div>
        </div>
        
        <!-- User Avatar with Dropdown -->
        <div class="vp-user-info">
          <div class="vp-user-avatar-dropdown">
            <div class="vp-user-avatar" id="vpUserAvatar">
              <span id="vpUserInitials">U</span>
            </div>
            <!-- User menu will be created dynamically by JavaScript -->
          </div>
        </div>
        
        <!-- Stop View As Button (only visible when impersonating) -->
        <button id="vpStopViewAsBtn" class="vp-header-btn vp-stop-impersonation" onclick="vpStopViewAs()" style="display: none;">
          ‚èπÔ∏è Stop
        </button>
        
      </div>
    </header>

    <!-- VP Main Content -->
    <div class="vp-main-content">
      <!-- VP Actions Container (Department Director ile aynƒ± layout) -->
      <div class="vp-actions-container" style="display: flex;">
        <!-- Left Section: VP Dashboard (including Financial Impact) -->
        <div class="vp-director-dashboard">
          <!-- VP Header -->
          <div class="vp-header-section" id="vpHeaderSection">
            <div class="vp-welcome">
              <div class="vp-badge">
                <span class="vp-icon">üè¢</span>
                <span class="vp-title" id="vpTitle">Loading Dashboard...</span>
              </div>
              <div class="vp-subtitle" id="vpSubtitle">
                Comprehensive overview of your department's audit actions and financial impact
              </div>
            </div>
            <!-- Loading Spinner for Stats -->
            <div class="vp-loading-container" id="vpStatsLoadingContainer">
              <div class="vp-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
              </div>
              <p class="vp-loading-text">Loading department's statistics...</p>
            </div>

            <div class="vp-department-stats" id="vpDepartmentStats" style="display: none;">
            <div class="vp-stat-item vp-total-actions-card">
              <div class="vp-toggle-indicator" id="vpTotalActionsIndicator">2024+</div>
              <div class="vp-stat-box">
                <div class="vp-stat-icon">üìä</div>
                <div class="vp-stat-content">
                  <span class="vp-stat-number" id="vpTotalDepartmentActions">-</span>
                  <span class="vp-stat-label">Total Actions</span>
                </div>
              </div>
            </div>
              <div class="vp-stat-item vp-completion-rate-card">
                <div class="vp-toggle-indicator" id="vpCompletionRateIndicator">2024+</div>
                <div class="vp-stat-box">
                  <div class="vp-stat-icon">üìà</div>
                  <div class="vp-stat-content">
                    <span class="vp-stat-number" id="vpDepartmentCompletionRate">-</span>
                    <span class="vp-stat-label">Completion Rate</span>
                  </div>
                </div>
              </div>
              <div class="vp-stat-item vp-overdue-rate-card">
                <div class="vp-toggle-indicator" id="vpOverdueRateIndicator">2024+</div>
                <div class="vp-stat-box">
                  <div class="vp-stat-icon">‚è∞</div>
                  <div class="vp-stat-content">
                    <span class="vp-stat-number" id="vpDepartmentOverdueRate">-</span>
                    <span class="vp-stat-label">Overdue Rate</span>
                  </div>
                </div>
              </div>
              <div class="vp-stat-item vp-open-actions-card">
                <div class="vp-toggle-indicator vp-fixed-as-of-2024">2024+</div>
                <div class="vp-stat-box">
                  <div class="vp-stat-content">
                    <span class="vp-stat-label">Financial Impact - Open Actions</span>
                    <span class="vp-stat-number" id="vpMoneyOpenValue">0 ‚Ç¨</span>
                  </div>
                </div>
              </div>
              <div class="vp-stat-item vp-overdue-actions-card">
                <div class="vp-toggle-indicator vp-fixed-as-of-2024">2024+</div>
                <div class="vp-stat-box">
                  <div class="vp-stat-content">
                    <span class="vp-stat-label">Financial Impact - Overdue Actions</span>
                    <span class="vp-stat-number" id="vpMoneyOverdueValue">0 ‚Ç¨</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Section: Chart Container -->
        <div class="vp-dashboard-content" id="vpActionsStatusCard">
          <div class="vp-chart-header">
            <h2>Action Ownership Breakdown</h2>
          </div>
          <!-- Modern Action Ownership Breakdown Chart Container -->
          <div class="vp-modern-ownership-container" style="position: relative;">
            <!-- Loading Spinner -->
            <div class="vp-modern-loading-container" id="vpOwnershipChartLoadingContainer">
              <div class="vp-modern-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
              </div>
              <p class="vp-loading-text">Loading ownership data...</p>
            </div>
            <div class="vp-ownership-chart-section" style="display: none;" id="vpOwnershipChartContent">
              <div class="vp-donut-chart-container">
                <canvas id="vpActionOwnershipChart"></canvas>
              </div>
              <div class="vp-ownership-center-text">
                <div class="vp-center-number" id="vpTotalActions">26</div>
                <div class="vp-center-label">Total Actions</div>
              </div>
            </div>
            <div class="vp-ownership-breakdown-section" style="display: none;" id="vpOwnershipBreakdownContent">
              <div class="vp-breakdown-cards" id="vpOwnershipBreakdownCards">
                <!-- Dynamic breakdown cards will be inserted here -->
              </div>
            </div>
          </div>
          <!-- Modern Pie Chart Container -->
          <div class="vp-modern-chart-container" id="vpPieChartContainer">
            <!-- Loading Spinner for Chart -->
            <div class="vp-modern-loading-container" id="vpChartLoadingContainer">
              <div class="vp-modern-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
              </div>
             
            </div>

            <!-- Modern Filter Bar -->
            <div class="vp-modern-filter-bar" style="display: none;">
              <div class="vp-toggle-option-modern active" data-value="2024+" onclick="vpSelectYearFilter('2024+')">
                <span class="vp-toggle-text-modern">As of 2024</span>
              </div>
            </div>

            <!-- Chart Container -->
            <div class="vp-pie-chart-container" id="vpPieChart" style="display: none;">
              <canvas id="vpPieChartCanvas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // VP Global Variables
    let vpBackendURL = window.location.origin;
    let vpUserEmail = null;
    let vpUserRole = null;
    let vpUserPermissions = null;
    let vpActionOwnershipChartInstance = null;
    let vpIsImpersonating = false;
    let vpImpersonatedUserEmail = null;
    let vpImpersonatedUserRole = null;
    let vpImpersonatedUserName = null;
    let vpImpersonatedUserCompany = null;
    let vpImpersonatedUserAccessReason = null;

    // VP Chart.js Plugins
    const vpChartDataLabels = ChartDataLabels;

    // VP Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      vpCheckAuthStatus();
      vpSetupEventListeners();
    });

    // VP Check Authentication Status
    async function vpCheckAuthStatus() {
      try {
        const response = await fetch(`${vpBackendURL}/api/auth/status`, {
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.authenticated) {
          vpUserEmail = data.user.email;
          vpUserRole = data.role;
          vpUserPermissions = data.permissions;
          
          // Update user info
          document.getElementById('vpUserInitials').textContent = vpUserEmail.charAt(0).toUpperCase();
          
          // Check View As status
          await vpCheckViewAsStatus();
          
          // Load VP data
          await vpLoadData();
        } else {
          // Redirect to login if not authenticated
          window.location.href = '/';
        }
      } catch (error) {
        console.error('VP Auth check error:', error);
        window.location.href = '/';
      }
    }

    // VP Setup Event Listeners
    function vpSetupEventListeners() {
      // VP Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        const vpViewAsMenu = document.getElementById('vpViewAsMenu');
        const vpViewAsBtn = document.querySelector('.vp-view-as-btn');
        
        if (vpViewAsMenu && vpViewAsBtn && !vpViewAsMenu.contains(event.target) && !vpViewAsBtn.contains(event.target)) {
          vpViewAsMenu.classList.remove('show');
        }
      });
    }

    // VP Toggle View As Dropdown
    function vpToggleViewAsDropdown() {
      const vpViewAsMenu = document.getElementById('vpViewAsMenu');
      vpViewAsMenu.classList.toggle('show');
      
      if (vpViewAsMenu.classList.contains('show')) {
        vpLoadUsers();
      }
    }

    // VP Check View As Status
    async function vpCheckViewAsStatus() {
      try {
        // Check impersonation status via API
        const response = await fetch(`${vpBackendURL}/api/check-view-as-status`, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const status = await response.json();
          
          if (status.isViewingAs) {
            // User is impersonating - show Stop View As button
            const stopBtn = document.getElementById('vpStopViewAsBtn');
            if (stopBtn) {
              stopBtn.style.display = 'block';
            }
            
            // View As dropdown'ƒ±nƒ± gizle
            const viewAsDropdown = document.getElementById('vpViewAsDropdown');
            if (viewAsDropdown) {
              viewAsDropdown.style.display = 'none';
            }
            
            // Set impersonation variables
            vpIsImpersonating = true;
            vpImpersonatedUserEmail = status.currentUser; // API'den currentUser geliyor, impersonatedUserEmail deƒüil
            vpImpersonatedUserRole = status.impersonatedUserRole;
            vpImpersonatedUserName = status.impersonatedUserName;
            vpImpersonatedUserCompany = status.impersonatedUserCompany;
            vpImpersonatedUserAccessReason = status.impersonatedUserAccessReason;
            
            
          } else {
            // User is not impersonating - hide Stop View As button
            const stopBtn = document.getElementById('vpStopViewAsBtn');
            if (stopBtn) {
              stopBtn.style.display = 'none';
            }
            
            // Show View As dropdown for admin users
            if (vpUserRole === 'admin') {
              const viewAsDropdown = document.getElementById('vpViewAsDropdown');
              if (viewAsDropdown) {
                viewAsDropdown.style.display = 'block';
              }
            }
            
            // Reset impersonation variables
            vpIsImpersonating = false;
            vpImpersonatedUserEmail = null;
            vpImpersonatedUserRole = null;
            vpImpersonatedUserName = null;
            vpImpersonatedUserCompany = null;
            vpImpersonatedUserAccessReason = null;
          }
        }
      } catch (error) {
        console.error('VP Check View As status error:', error);
      }
    }

    // VP Load Users for View As
    async function vpLoadUsers() {
      try {
        const response = await fetch(`${vpBackendURL}/api/users`, {
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.success) {
          const vpUserList = document.getElementById('vpUserList');
          vpUserList.innerHTML = '';
          
          data.users.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'vp-user-item';
            userItem.onclick = () => vpStartImpersonation(user);
            
            userItem.innerHTML = `
              <div class="vp-user-name">${user.name || user.email}</div>
              <div class="vp-user-email">${user.email}</div>
            `;
            
            vpUserList.appendChild(userItem);
          });
        }
      } catch (error) {
        console.error('VP Load users error:', error);
      }
    }

    // VP Search Users
    function vpSearchUsers() {
      const searchTerm = document.getElementById('vpUserSearch').value.toLowerCase();
      const userItems = document.querySelectorAll('.vp-user-item');
      
      userItems.forEach(item => {
        const name = item.querySelector('.vp-user-name').textContent.toLowerCase();
        const email = item.querySelector('.vp-user-email').textContent.toLowerCase();
        
        if (name.includes(searchTerm) || email.includes(searchTerm)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // VP Start Impersonation
    async function vpStartImpersonation(user) {
      try {
        const response = await fetch(`${vpBackendURL}/api/view-as-user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({
            targetEmail: user.email
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Role-based page routing for View As - Department Director ile aynƒ±
          if (data.role === 'VP') {
            window.location.href = '/man.html';
          } else if (data.role === 'department_director') {
            window.location.href = '/department-director.html';
          } else {
            // Admin veya ba≈üka roller i√ßin index'e y√∂nlendir
            window.location.href = '/';
          }
        } else {
          const data = await response.json();
          alert('Failed to start impersonation: ' + data.message);
        }
      } catch (error) {
        console.error('VP Start impersonation error:', error);
        alert('Failed to start impersonation');
      }
    }

    // VP Stop View As
    async function vpStopViewAs() {
      try {
        const response = await fetch(`${vpBackendURL}/api/admin/stop-impersonation`, {
          method: 'POST',
          credentials: 'include'
        });
        
        if (response.ok) {
          // Admin view'e d√∂n (index.html) - Department Director ile aynƒ±
          window.location.href = '/';
        } else {
          const data = await response.json();
          alert('Failed to stop impersonation: ' + data.message);
        }
      } catch (error) {
        console.error('VP Stop impersonation error:', error);
        alert('Failed to stop impersonation');
      }
    }


    // VP Load Data
    // VP Format Money Value - Department Director ile aynƒ± format
    function vpFormatMoneyValue(value) {
      if (!value || isNaN(value)) return '0 ‚Ç¨';
      
      const num = parseFloat(value);
      
      if (num >= 1000000) {
        return `${(num / 1000000).toFixed(1)}M ‚Ç¨`;
      } else if (num >= 1000) {
        return `${(num / 1000).toFixed(1)}K ‚Ç¨`;
      } else {
        return `${num.toFixed(0)} ‚Ç¨`;
      }
    }

    async function vpLoadData(auditYear = '2024+') {
      try {
        console.log('VP Load Data called with auditYear:', auditYear);
        
        // Load VP stats
        await vpLoadStats(auditYear);
        
        // Load Action Ownership Breakdown Chart
        await vpLoadActionOwnershipChart(auditYear);
        
      } catch (error) {
        console.error('VP Load data error:', error);
      }
    }

    // VP Load Action Ownership Chart
    async function vpLoadActionOwnershipChart(auditYear) {
      try {
        const url = new URL(`${vpBackendURL}/api/vp-finding-actions`);
        url.searchParams.append('email', vpIsImpersonating ? vpImpersonatedUserEmail : vpUserEmail);
        if (auditYear && auditYear !== 'all') {
          url.searchParams.append('auditYear', auditYear);
        }
        
        const response = await fetch(url, { credentials: 'include' });
        const data = await response.json();
        
        if (data.actions) {
          vpRenderActionOwnershipChart(data.actions);
        }
      } catch (error) {
        console.error('VP Load Action Ownership Chart error:', error);
      }
    }

    // VP Load Stats
    async function vpLoadStats(auditYear) {
      try {
        const emailToUse = vpIsImpersonating ? vpImpersonatedUserEmail : vpUserEmail;
        
        const url = new URL(`${vpBackendURL}/api/vp-finding-actions`);
        url.searchParams.append('email', emailToUse);
        if (auditYear && auditYear !== 'all') {
          url.searchParams.append('auditYear', auditYear);
        }
        
        const response = await fetch(url, { credentials: 'include' });
        const data = await response.json();
        
        if (data.success) {
          // Update VP title
          const vpTitle = document.getElementById('vpTitle');
          if (vpTitle) {
            vpTitle.textContent = `${data.userDepartment || 'VP'} - Audit Actions Overview`;
          }
          
          // Hide loading spinner
          const loadingContainer = document.getElementById('vpStatsLoadingContainer');
          if (loadingContainer) {
            loadingContainer.style.display = 'none';
          }
          
          // Show stats container
          const statsContainer = document.getElementById('vpDepartmentStats');
          if (statsContainer) {
            statsContainer.style.display = 'grid';
          }
          
          // Update stats
          document.getElementById('vpTotalDepartmentActions').textContent = data.totalActions || 0;
          document.getElementById('vpDepartmentCompletionRate').textContent = data.completionRate ? `${data.completionRate}%` : '0%';
          document.getElementById('vpDepartmentOverdueRate').textContent = data.overdueRate ? `${data.overdueRate}%` : '0%';
          document.getElementById('vpMoneyOpenValue').textContent = vpFormatMoneyValue(data.moneyOpen);
          document.getElementById('vpMoneyOverdueValue').textContent = vpFormatMoneyValue(data.moneyOverdue);
        }
      } catch (error) {
        console.error('VP Load stats error:', error);
      }
    }


    // VP Year Filter Function
    function vpSelectYearFilter(year) {
      // Update active filter
      document.querySelectorAll('.vp-toggle-option-modern').forEach(option => {
        option.classList.remove('active');
      });
      event.target.closest('.vp-toggle-option-modern').classList.add('active');
      
      // Reload data with new filter
      vpLoadStats();
      vpLoadActionOwnershipChart();
    }


    // VP Render Modern Action Ownership Breakdown Chart
    function vpRenderActionOwnershipChart(actions) {
      console.log('üîç VP Modern Action Ownership Breakdown Chart - Starting render...');
      console.log('üîç Actions data:', actions);
      
      // Hide loading spinner
      const loadingContainer = document.getElementById('vpOwnershipChartLoadingContainer');
      if (loadingContainer) {
        loadingContainer.style.display = 'none';
      }
      
      // Show chart content
      const chartContent = document.getElementById('vpOwnershipChartContent');
      const breakdownContent = document.getElementById('vpOwnershipBreakdownContent');
      if (chartContent) {
        chartContent.style.display = 'flex';
      }
      if (breakdownContent) {
        breakdownContent.style.display = 'flex';
      }
      
      const canvasElement = document.getElementById('vpActionOwnershipChart');
      if (!canvasElement) {
        console.error('‚ùå VP Action Ownership Breakdown: Canvas element not found!');
        return;
      }
      
      const ctx = canvasElement.getContext('2d');
      console.log('‚úÖ VP Action Ownership Breakdown: Canvas context created');
      
      // Destroy existing chart
      if (vpActionOwnershipChartInstance) {
        console.log('üîç VP Action Ownership Breakdown: Destroying existing chart');
        vpActionOwnershipChartInstance.destroy();
      }
      
      if (!actions || actions.length === 0) {
        console.log('‚ö†Ô∏è VP Action Ownership Breakdown: No actions data available');
        return;
      }

      // Ownership breakdown hesapla - ActionResponsibleEmail'e g√∂re grupla
      const ownershipBreakdown = {};
      
      actions.forEach(action => {
        const responsibleEmail = action.ActionResponsibleEmail;
        const status = action.ActionStatus;
        
        if (!responsibleEmail) return; // Email yoksa atla
        
        if (!ownershipBreakdown[responsibleEmail]) {
          ownershipBreakdown[responsibleEmail] = {
            email: responsibleEmail,
            total: 0,
            statusBreakdown: {}
          };
        }
        
        ownershipBreakdown[responsibleEmail].total++;
        
        // Status breakdown
        if (!ownershipBreakdown[responsibleEmail].statusBreakdown[status]) {
          ownershipBreakdown[responsibleEmail].statusBreakdown[status] = 0;
        }
        ownershipBreakdown[responsibleEmail].statusBreakdown[status]++;
      });

      // Chart i√ßin data hazƒ±rla
      const labels = Object.keys(ownershipBreakdown);
      const data = Object.values(ownershipBreakdown).map(item => item.total);
      const totalActions = data.reduce((sum, count) => sum + count, 0);
      
      // Email'leri kƒ±salt (√∂rnek: beste.bulut@getir.com -> beste.bulut)
      const shortLabels = labels.map(email => {
        const name = email.split('@')[0];
        return name.split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
      });

      // Modern renk paleti
      const modernColors = [
        '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
        '#06b6d4', '#f97316', '#84cc16', '#ec4899', '#6366f1'
      ];
      
      const backgroundColors = labels.map((_, index) => modernColors[index % modernColors.length]);
      
      console.log('üîç VP Action Ownership Breakdown: Chart data prepared');
      console.log('üîç Labels:', shortLabels);
      console.log('üîç Data:', data);
      console.log('üîç Total Actions:', totalActions);
      
      // Total actions'ƒ± center'a yaz
      const totalActionsElement = document.getElementById('vpTotalActions');
      if (totalActionsElement) {
        totalActionsElement.textContent = totalActions;
      }
      
      // Modern donut chart olu≈ütur
      try {
        vpActionOwnershipChartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: shortLabels,
            datasets: [{
              data: data,
              backgroundColor: backgroundColors,
              borderColor: '#ffffff',
              borderWidth: 3,
              hoverBorderWidth: 4,
              hoverBorderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                enabled: true,
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: 'rgba(255, 255, 255, 0.2)',
                borderWidth: 1,
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  label: function(context) {
                    const percentage = ((context.parsed / totalActions) * 100).toFixed(1);
                    return `${context.label}: ${context.parsed} actions (${percentage}%)`;
                  }
                }
              }
            },
            animation: {
              animateRotate: true,
              animateScale: true,
              duration: 2000,
              easing: 'easeInOutQuart'
            },
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const email = labels[index];
                const breakdown = ownershipBreakdown[email];
                
                // Status breakdown g√∂ster
                const statusInfo = Object.entries(breakdown.statusBreakdown)
                  .map(([status, count]) => `${status}: ${count}`)
                  .join(', ');
                
                console.log(`üìä ${email}: ${breakdown.total} actions (${statusInfo})`);
              }
            }
          }
        });
        
        // Breakdown cards olu≈ütur
        vpCreateOwnershipBreakdownCards(ownershipBreakdown, totalActions, modernColors);
        
        console.log('‚úÖ VP Modern Action Ownership Breakdown Chart rendered successfully');
        console.log('üìä Ownership Data:', ownershipBreakdown);
        
      } catch (error) {
        console.error('‚ùå VP Action Ownership Breakdown Chart Error:', error);
        console.error('‚ùå Error details:', error.message);
      }
    }

    // VP Create Ownership Breakdown Cards
    function vpCreateOwnershipBreakdownCards(ownershipBreakdown, totalActions, colors) {
      const cardsContainer = document.getElementById('vpOwnershipBreakdownCards');
      if (!cardsContainer) return;
      
      // Container'ƒ± temizle
      cardsContainer.innerHTML = '';
      
      // Ownership data'yƒ± toplam action sayƒ±sƒ±na g√∂re sƒ±rala (b√ºy√ºkten k√º√ß√ºƒüe)
      const sortedOwnership = Object.entries(ownershipBreakdown)
        .sort(([,a], [,b]) => b.total - a.total);
      
      sortedOwnership.forEach(([email, data], index) => {
        const percentage = ((data.total / totalActions) * 100).toFixed(1);
        const color = colors[index % colors.length];
        
        // Email'den isim √ßƒ±kar
        const name = email.split('@')[0];
        const displayName = name.split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
        
        // Status badges olu≈ütur
        const statusBadges = Object.entries(data.statusBreakdown)
          .map(([status, count]) => {
            const statusClass = status.toLowerCase().replace(/\s+/g, '-');
            return `<span class="vp-status-badge ${statusClass}">${status} (${count})</span>`;
          })
          .join('');
        
        // Card HTML olu≈ütur
        const cardHTML = `
          <div class="vp-ownership-card" data-email="${email}">
            <div class="vp-ownership-color-indicator" style="background-color: ${color}"></div>
            <div class="vp-ownership-info">
              <div class="vp-ownership-name">${displayName}</div>
              <div class="vp-ownership-email">${email}</div>
              <div class="vp-ownership-status-badges">${statusBadges}</div>
            </div>
            <div class="vp-ownership-stats">
              <div class="vp-ownership-count">${data.total}</div>
              <div class="vp-ownership-percentage">${percentage}%</div>
            </div>
          </div>
        `;
        
        cardsContainer.insertAdjacentHTML('beforeend', cardHTML);
      });
      
      // Card click event'leri ekle
      const cards = cardsContainer.querySelectorAll('.vp-ownership-card');
      cards.forEach(card => {
        card.addEventListener('click', function() {
          const email = this.dataset.email;
          const breakdown = ownershipBreakdown[email];
          console.log(`üìä Clicked on ${email}:`, breakdown);
        });
      });
    }


  </script>
</body>
</html>